const Web3=require('web3')
const ganache=require('ganache-cli')
const web3=new Web3(ganache.provider())
const abi=[ { "constant": true, "inputs": [], "name": "getFundingList", "outputs": [ { "name": "", "type": "address[]" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "name", "type": "string" }, { "name": "targetMoney", "type": "uint256" }, { "name": "supportMoney", "type": "uint256" }, { "name": "duration", "type": "uint256" } ], "name": "createCrowdFunding", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [ { "name": "investor", "type": "address" } ], "name": "getInvestorFundingList", "outputs": [ { "name": "", "type": "address[]" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [ { "name": "creator", "type": "address" } ], "name": "getCreatorFundingList", "outputs": [ { "name": "", "type": "address[]" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" } ]
const bytecode='608060405234801561001057600080fd5b50600061001b610081565b604051809103906000f080158015610037573d6000803e3d6000fd5b50905080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050610091565b60405161030a80611d1083390190565b611c70806100a06000396000f300608060405260043610610062576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632966fa23146100675780635496cbc5146100d3578063921df6e11461015a57806397f77d12146101f2575b600080fd5b34801561007357600080fd5b5061007c61028a565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156100bf5780820151818401526020810190506100a4565b505050509050019250505060405180910390f35b3480156100df57600080fd5b50610158600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291908035906020019092919080359060200190929190505050610318565b005b34801561016657600080fd5b5061019b600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610563565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156101de5780820151818401526020810190506101c3565b505050509050019250505060405180910390f35b3480156101fe57600080fd5b50610233600480360381019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506106ba565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561027657808201518184015260208101905061025b565b505050509050019250505060405180910390f35b6060600080548060200260200160405190810160405280929190818152602001828054801561030e57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116102c4575b5050505050905090565b60008484848433600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1661034a610787565b80806020018781526020018681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828103825288818151815260200191508051906020019080838360005b838110156103fd5780820151818401526020810190506103e2565b50505050905090810190601f16801561042a5780820380516001836020036101000a031916815260200191505b50975050505050505050604051809103906000f080158015610450573d6000803e3d6000fd5b50905060008190806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050505050565b6060600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663921df6e1836040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050600060405180830381600087803b15801561062257600080fd5b505af1158015610636573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f82011682018060405250602081101561066057600080fd5b81019080805164010000000081111561067857600080fd5b8281019050602081018481111561068e57600080fd5b81518560208202830111640100000000821117156106ab57600080fd5b50509291905050509050919050565b6060600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002080548060200260200160405190810160405280929190818152602001828054801561077b57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610731575b50505050509050919050565b6040516114ad8061079883390190560060806040523480156200001157600080fd5b50604051620014ad380380620014ad83398101806040528101908080518201929190602001805190602001909291908051906020019092919080519060200190929190805190602001909291908051906020019092919050505085600090805190602001906200008392919062000129565b50846001819055508360028190555082420160038190555081600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600960006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050505050620001d8565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200016c57805160ff19168380011785556200019d565b828001600101855582156200019d579182015b828111156200019c5782518255916020019190600101906200017f565b5b509050620001ac9190620001b0565b5090565b620001d591905b80821115620001d1576000816000905550600101620001b7565b5090565b90565b6112c580620001e86000396000f3006080604052600436106100e6576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806302d05d3f146100eb578063034410061461014257806306fdde031461016f578063119f8747146101ff57806312065fe0146102095780631b16bb5c146102345780633197cbb6146102c75780633fad1834146102f25780638d7cdb911461031d5780639311931214610348578063960524e31461035f578063a5d5c5dc1461038a578063b2f5a54c146103b5578063c58343ef14610421578063c7e284b81461051a578063d7d1bbdb14610545575b600080fd5b3480156100f757600080fd5b50610100610572565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561014e57600080fd5b5061016d60048036038101908080359060200190929190505050610598565b005b34801561017b57600080fd5b5061018461070c565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101c45780820151818401526020810190506101a9565b50505050905090810190601f1680156101f15780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6102076107aa565b005b34801561021557600080fd5b5061021e610a39565b6040518082815260200191505060405180910390f35b34801561024057600080fd5b506102c5600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610a58565b005b3480156102d357600080fd5b506102dc610bd5565b6040518082815260200191505060405180910390f35b3480156102fe57600080fd5b50610307610bdb565b6040518082815260200191505060405180910390f35b34801561032957600080fd5b50610332610be8565b6040518082815260200191505060405180910390f35b34801561035457600080fd5b5061035d610bee565b005b34801561036b57600080fd5b50610374610e3d565b6040518082815260200191505060405180910390f35b34801561039657600080fd5b5061039f610e4a565b6040518082815260200191505060405180910390f35b3480156103c157600080fd5b506103ca610e50565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561040d5780820151818401526020810190506103f2565b505050509050019250505060405180910390f35b34801561042d57600080fd5b5061044c60048036038101908080359060200190929190505050610ede565b60405180806020018773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200186815260200185815260200184815260200183151515158152602001828103825288818151815260200191508051906020019080838360005b838110156104da5780820151818401526020810190506104bf565b50505050905090810190601f1680156105075780820380516001836020036101000a031916815260200191505b5097505050505050505060405180910390f35b34801561052657600080fd5b5061052f611059565b6040518082815260200191505060405180910390f35b34801561055157600080fd5b5061057060048036038101908080359060200190929190505050611079565b005b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156105f657600080fd5b60088281548110151561060557fe5b906000526020600020906006020190506000600181111561062257fe5b8160040160009054906101000a900460ff16600181111561063f57fe5b14151561064b57600080fd5b600580549050600282600301540211151561066557600080fd5b60018160040160006101000a81548160ff0219169083600181111561068657fe5b0217905550600081600201541115610708578060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82600201549081150290604051600060405180830381858888f19350505050158015610706573d6000803e3d6000fd5b505b5050565b60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107a25780601f10610777576101008083540402835291602001916107a2565b820191906000526020600020905b81548152906001019060200180831161078557829003601f168201915b505050505081565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415151561080757600080fd5b6002543414151561081757600080fd5b600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151561087057600080fd5b60053390806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550506001600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663b1c4907933306040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b158015610a1f57600080fd5b505af1158015610a33573d6000803e3d6000fd5b50505050565b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610ab457600080fd5b600860a0604051908101604052808581526020018473ffffffffffffffffffffffffffffffffffffffff1681526020018381526020016000815260200160006001811115610afe57fe5b815250908060018154018082558091505090600182039060005260206000209060060201600090919290919091506000820151816000019080519060200190610b489291906111f4565b5060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550604082015181600201556060820151816003015560808201518160040160006101000a81548160ff02191690836001811115610bc857fe5b0217905550505050505050565b60035481565b6000600880549050905090565b60015481565b6000600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610c4c57600080fd5b600580549050600254023073ffffffffffffffffffffffffffffffffffffffff163110151515610c7b57600080fd5b600090505b600580549050811015610e3a5760076000600583815481101515610ca057fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515610d9c57600581815481101515610d2857fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6002549081150290604051600060405180830381858888f19350505050158015610d9a573d6000803e3d6000fd5b505b600160076000600584815481101515610db157fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080600101915050610c80565b50565b6000600580549050905090565b60025481565b60606005805480602002602001604051908101604052809291908181526020018280548015610ed457602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610e8a575b5050505050905090565b6060600080600080600080600888815481101515610ef857fe5b90600052602060002090600602019050806000018160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16826002015483600301548460040160009054906101000a900460ff166001811115610f5857fe5b8560050160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16858054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561103c5780601f106110115761010080835404028352916020019161103c565b820191906000526020600020905b81548152906001019060200180831161101f57829003601f168201915b505050505095509650965096509650965096505091939550919395565b600042600354101561106e5760009050611076565b426003540390505b90565b6000600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615156110d357600080fd5b6008828154811015156110e257fe5b906000526020600020906006020190508060050160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151561114d57600080fd5b6000600181111561115a57fe5b8160040160009054906101000a900460ff16600181111561117757fe5b14151561118357600080fd5b6001816003016000828254019250508190555060018160050160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061123557805160ff1916838001178555611263565b82800160010185558215611263579182015b82811115611262578251825591602001919060010190611247565b5b5090506112709190611274565b5090565b61129691905b8082111561129257600081600090555060010161127a565b5090565b905600a165627a7a72305820a370fbc5692cb63ed2ef019f1dce4db2a919e04d97a483e9d21a06e70ba30dad0029a165627a7a723058209dcfee354aca2d930d03cf6551622409cf7065b919b2f00ea67d962f53991b920029608060405234801561001057600080fd5b506102ea806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063921df6e114610051578063b1c49079146100e9575b600080fd5b34801561005d57600080fd5b50610092600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061014c565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156100d55780820151818401526020810190506100ba565b505050509050019250505060405180910390f35b3480156100f557600080fd5b5061014a600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610218565b005b60606000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002080548060200260200160405190810160405280929190818152602001828054801561020c57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116101c2575b50505050509050919050565b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050505600a165627a7a723058203a9fba800d67fc90602dc9eeff225ccc1603ed75bb7d30922e710f32bb0f78d40029'
const crowdFundingABI=[ { "constant": true, "inputs": [], "name": "creator", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "requestId", "type": "uint256" } ], "name": "finalizeRequest", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "name", "outputs": [ { "name": "", "type": "string" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "support", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function" }, { "constant": true, "inputs": [], "name": "getBalance", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "purpose", "type": "string" }, { "name": "to", "type": "address" }, { "name": "amount", "type": "uint256" } ], "name": "createRequest", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "endTime", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "getRequestCount", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "targetMoney", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "returnMoney", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "getInvestorCount", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "supportMoney", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "getInvestors", "outputs": [ { "name": "", "type": "address[]" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [ { "name": "requestId", "type": "uint256" } ], "name": "getRequest", "outputs": [ { "name": "", "type": "string" }, { "name": "", "type": "address" }, { "name": "", "type": "uint256" }, { "name": "", "type": "uint256" }, { "name": "", "type": "uint256" }, { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "getTimeLeft", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "requestId", "type": "uint256" } ], "name": "approveRequest", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "name": "_name", "type": "string" }, { "name": "_targetMoney", "type": "uint256" }, { "name": "_supportMoney", "type": "uint256" }, { "name": "duration", "type": "uint256" }, { "name": "_creator", "type": "address" }, { "name": "_i2f", "type": "address" } ], "payable": false, "stateMutability": "nonpayable", "type": "constructor" } ]
const assert=require('assert')
const arrayEqual=(a1,a2) => {
    if (a1.length!=a2.length) return false
    for (let i=0;i<a2.length;i++) {
        if (a1[i]!=a2[i]) return false
    }
    return true
}
let accounts
let instance
let getCrowdFundingInstance
beforeEach(async () => {
    accounts=await web3.eth.getAccounts()
    instance=await new web3.eth.Contract(abi).deploy({data:bytecode}).send({from:accounts[0],gas:3000000})
    getCrowdFundingInstance=() => new web3.eth.Contract(crowdFundingABI)
})
describe('CrowdFundingFactory',() => {
    it('createCrowdFunding',async () => {
        await instance.methods.createCrowdFunding('AI Research',web3.utils.toWei('3','ether'),web3.utils.toWei('1','ether'),60).send({from:accounts[1],gas:3000000})
        await instance.methods.createCrowdFunding('Store',web3.utils.toWei('3','ether'),web3.utils.toWei('1','ether'),60).send({from:accounts[2],gas:3000000})
        await instance.methods.createCrowdFunding('Blockchain Research',web3.utils.toWei('3','ether'),web3.utils.toWei('1','ether'),60).send({from:accounts[1],gas:3000000})
        let fundingList=await instance.methods.getFundingList().call()
        let creatorFundingList=await instance.methods.getCreatorFundingList(accounts[1]).call()
        assert(arrayEqual(creatorFundingList,[fundingList[0],fundingList[2]]),true,'')
        let crowdFundingInstance=getCrowdFundingInstance()
        crowdFundingInstance.options.address=fundingList[0]
        await crowdFundingInstance.methods.support().send({from:accounts[3],gas:3000000,value:web3.utils.toWei('1','ether')})
        crowdFundingInstance=getCrowdFundingInstance()
        crowdFundingInstance.options.address=fundingList[1]
        await crowdFundingInstance.methods.support().send({from:accounts[3],gas:3000000,value:web3.utils.toWei('1','ether')})
        let investorFundingList=await instance.methods.getInvestorFundingList(accounts[3]).call()
        assert(arrayEqual(investorFundingList,[fundingList[0],fundingList[1]]),true,'')
    })
})
